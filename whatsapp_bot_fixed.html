<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WhatsApp Bot - Sistema de Gestão</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

  <style>
    :root{
      --brand:#25D366;
      --brand-700:#128C7E;
      --bg-a:#667eea;
      --bg-b:#764ba2;
      --card-bg:rgba(255,255,255,.95);
      --muted:#64748b;
      --ink:#1f2937;
      --ink-2:#374151;
      --radius:18px;
      --shadow-lg:0 10px 30px rgba(0,0,0,.10);
      --shadow-xl:0 20px 40px rgba(0,0,0,.15);
    }

    /* Reset & base */
    *{margin:0;padding:0;box-sizing:border-box}
    html,body{height:100%}
    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;
      background:linear-gradient(135deg,var(--bg-a) 0%,var(--bg-b) 100%);
      color:#333; min-height:100vh; overflow-x:hidden;
    }

    .app-container{display:flex;min-height:100vh}

    /* Sidebar */
    .sidebar{
      width:280px;background:var(--card-bg);backdrop-filter:blur(15px);
      box-shadow:2px 0 20px rgba(0,0,0,.1);
      display:flex;flex-direction:column;position:fixed;inset:0 auto 0 0;z-index:1000;
      transition:transform .3s ease;
    }
    .sidebar-header{padding:25px;border-bottom:1px solid rgba(0,0,0,.08);
      background:linear-gradient(135deg,var(--brand),var(--brand-700));color:#fff}
    .sidebar-header h2{font-size:20px;font-weight:700;display:flex;align-items:center;gap:12px}
    .logo-icon{width:40px;height:40px;background:rgba(255,255,255,.2);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px}

    .sidebar-nav{flex:1;padding:20px 0;overflow-y:auto}
    .nav-section{margin-bottom:30px}
    .nav-section-title{padding:0 25px 10px;font-size:12px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px}
    .nav-item{
      display:flex;align-items:center;padding:12px 25px;color:#475569;text-decoration:none;
      transition:all .3s ease;border-left:3px solid transparent;cursor:pointer
    }
    .nav-item .nav-icon{width:20px;margin-right:15px;text-align:center;font-size:16px}
    .nav-item .nav-text{flex:1;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .nav-item .nav-badge{background:#ef4444;color:#fff;font-size:11px;padding:2px 8px;border-radius:12px;font-weight:600}
    .nav-item:hover{background:rgba(37,211,102,.10);color:var(--brand);border-left-color:var(--brand)}
    .nav-item.active{background:rgba(37,211,102,.15);color:var(--brand);border-left-color:var(--brand);font-weight:600}

    /* Mobile toggle & overlay */
    .mobile-menu-toggle{
      display:none;position:fixed;top:20px;left:20px;z-index:1001;
      background:rgba(255,255,255,.9);border:none;padding:12px;border-radius:12px;cursor:pointer;
      box-shadow:0 4px 12px rgba(0,0,0,.1)
    }
    .sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:999}
    .sidebar-overlay.active{display:block}

    /* Main */
    .main-content{flex:1;margin-left:280px;padding:0;transition:margin-left .3s ease}
    .container{max-width:1200px;margin:0 auto;padding:30px}

    /* Header */
    .header{
      background:var(--card-bg);backdrop-filter:blur(10px);border-radius:20px;
      padding:25px 30px;margin-bottom:30px;box-shadow:var(--shadow-lg);
      display:flex;justify-content:space-between;align-items:center
    }
    .header h1{font-size:28px;font-weight:700;color:#2d3748;display:flex;align-items:center;gap:12px}
    .header h1 i{color:var(--brand);font-size:32px}

    /* Buttons */
    .btn-primary{
      background:linear-gradient(135deg,var(--brand),var(--brand-700));color:#fff;border:none;
      padding:12px 24px;border-radius:12px;font-weight:600;font-size:14px;cursor:pointer;transition:all .3s ease;
      display:flex;align-items:center;gap:8px;text-decoration:none
    }
    .btn-primary:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(37,211,102,.3)}

    .btn-action{
      flex:1;padding:8px 16px;border:none;border-radius:8px;font-weight:600;font-size:12px;cursor:pointer;transition:all .3s ease;
      display:flex;align-items:center;justify-content:center;gap:6px
    }
    .btn-action:hover{transform:translateY(-1px)}
    .btn-edit{background:#3b82f6;color:#fff}
    .btn-delete{background:#ef4444;color:#fff}
    .btn-connect{background:var(--brand);color:#fff}

    /* Metrics */
    .dashboard-metrics{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;margin-bottom:30px}
    .metric-card{background:var(--card-bg);backdrop-filter:blur(10px);border-radius:16px;padding:20px;box-shadow:var(--shadow-lg);transition:all .3s ease}
    .metric-card:hover{transform:translateY(-3px);box-shadow:0 15px 35px rgba(0,0,0,.15)}
    .metric-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:15px}
    .metric-title{font-size:14px;font-weight:600;color:var(--muted)}
    .metric-icon{width:35px;height:35px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:16px;background:#dcfce7;color:#16a34a}
    .metric-value{font-size:28px;font-weight:700;color:var(--ink);margin-bottom:8px}
    .metric-subtitle{font-size:12px;color:#6b7280;margin-bottom:15px}

    .metric-breakdown{border-top:1px solid #f1f5f9;padding-top:10px}
    .breakdown-item{display:flex;justify-content:space-between;align-items:center;padding:3px 0;font-size:12px}
    .breakdown-label{color:var(--muted)}
    .breakdown-value{font-weight:600;color:var(--ink-2)}

    /* Cards / grids */
    .content-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(350px,1fr));gap:25px}
    .content-card{
      background:var(--card-bg);backdrop-filter:blur(10px);border-radius:var(--radius);padding:25px;box-shadow:var(--shadow-lg);
      transition:all .3s ease;position:relative;overflow:hidden
    }
    .content-card:hover{transform:translateY(-5px);box-shadow:var(--shadow-xl)}
    .card-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:15px}
    .card-title{font-size:18px;font-weight:700;color:var(--ink);margin-bottom:5px}
    .card-subtitle{font-size:14px;color:#6b7280;line-height:1.5}
    .card-status{position:absolute;top:15px;right:15px;padding:4px 10px;border-radius:15px;font-size:11px;font-weight:600;text-transform:uppercase}
    .status-active{background:#dcfce7;color:#166534}
    .status-pending{background:#fef3c7;color:#92400e}
    .status-offline{background:#f3f4f6;color:#4b5563}

    .card-actions{display:flex;gap:8px;margin-top:15px}

    /* Tables */
    .data-table{background:var(--card-bg);backdrop-filter:blur(10px);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow-lg)}
    .table-header{background:#f8fafc;padding:20px 25px;border-bottom:1px solid #e5e7eb}
    .table-title{font-size:18px;font-weight:700;color:var(--ink)}
    .table-content{overflow-x:auto}
    table{width:100%;border-collapse:collapse}
    th,td{padding:15px 25px;text-align:left;border-bottom:1px solid #f1f5f9}
    th{background:#f8fafc;font-weight:600;color:var(--ink-2);font-size:14px}
    td{color:#4b5563;font-size:14px}

    .status-badge{display:inline-flex;align-items:center;gap:5px;padding:4px 8px;border-radius:10px;font-size:11px;font-weight:600}
    .status-online{background:#dcfce7;color:#166534}
    .status-away{background:#fef3c7;color:#92400e}
    .status-error{background:#fee2e2;color:#991b1b}

    /* Instance selector (footer) */
    .sidebar-footer{margin-top:auto;border-top:1px solid rgba(0,0,0,.08);position:relative}
    .instance-selector{padding:20px;display:flex;align-items:center;gap:12px;cursor:pointer;transition:all .3s ease;background:rgba(37,211,102,.05)}
    .instance-selector:hover{background:rgba(37,211,102,.10)}
    .instance-avatar{position:relative;flex-shrink:0}
    .instance-avatar img{width:40px;height:40px;border-radius:50%;object-fit:cover;border:2px solid var(--brand)}
    .instance-status{position:absolute;bottom:0;right:0;width:12px;height:12px;background:#10B981;border:2px solid #fff;border-radius:50%}
    .instance-info{flex:1;min-width:0}
    .instance-name{font-size:14px;font-weight:600;color:var(--ink)}
    .instance-type{font-size:12px;color:var(--muted)}
    .instance-arrow{color:var(--muted);transition:transform .3s ease}
    .instance-arrow.active{transform:rotate(180deg)}

    .instance-dropdown{
      position:absolute;bottom:100%;left:0;right:0;background:#fff;border-radius:12px 12px 0 0;
      box-shadow:0 -10px 30px rgba(0,0,0,.2);opacity:0;visibility:hidden;transform:translateY(10px);
      transition:all .3s ease;z-index:1000;max-height:400px;overflow-y:auto
    }
    .instance-dropdown.active{opacity:1;visibility:visible;transform:translateY(0)}
    .dropdown-header{padding:15px 20px;border-bottom:1px solid #e5e7eb;font-size:12px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px}
    .instance-item{padding:12px 20px;display:flex;align-items:center;gap:12px;cursor:pointer;transition:all .3s ease}
    .instance-item:hover{background:#f8fafc}
    .instance-item.active{background:rgba(37,211,102,.10)}
    .instance-avatar-small{position:relative;flex-shrink:0}
    .instance-avatar-small img{width:32px;height:32px;border-radius:50%;object-fit:cover}
    .status-dot{position:absolute;bottom:0;right:0;width:10px;height:10px;border:2px solid #fff;border-radius:50%}
    .status-dot.active{background:#10B981}
    .status-dot.pending{background:#F59E0B}
    .status-dot.offline{background:#6B7280}
    .instance-details{flex:1;min-width:0}
    .instance-details .name{font-size:14px;font-weight:600;color:var(--ink)}
    .instance-details .type{font-size:12px;color:var(--muted)}
    .instance-check{color:var(--brand);font-size:14px}
    .dropdown-footer{border-top:1px solid #e5e7eb;padding:8px}
    .dropdown-action{padding:10px 16px;display:flex;align-items:center;gap:10px;cursor:pointer;border-radius:8px;transition:all .3s ease;font-size:13px;color:#475569}
    .dropdown-action:hover{background:#f1f5f9;color:var(--brand)}
    .dropdown-action i{width:16px;text-align:center}

    /* Forms */
    .form-group{margin-bottom:20px}
    .form-label{display:block;font-size:14px;font-weight:600;color:var(--ink-2);margin-bottom:8px}
    .form-input,.form-select,.form-textarea{
      width:100%;padding:12px 16px;border:2px solid #e5e7eb;border-radius:10px;font-size:14px;color:var(--ink-2);background:#fff;transition:border-color .3s ease
    }
    .form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--brand);box-shadow:0 0 0 3px rgba(37,211,102,.10)}
    .form-textarea{min-height:100px;resize:vertical}

    /* Settings grid */
    .settings-grid{display:grid;grid-template-columns:1fr 1fr;gap:30px;margin-bottom:30px}
    .advanced-settings{margin-top:30px}
    .advanced-settings .settings-grid{padding:20px;margin-bottom:0}

    /* Modal */
    .modal-overlay{position:fixed;inset:0;background:rgba(15,23,42,.55);backdrop-filter:blur(2px);display:flex;align-items:center;justify-content:center;z-index:2000}
    .modal-box{width:min(540px,92vw);background:#fff;border-radius:16px;overflow:hidden;box-shadow:0 25px 60px rgba(0,0,0,.25);animation:modalIn .16s ease-out}
    @keyframes modalIn{from{transform:translateY(6px);opacity:.9}to{transform:none;opacity:1}}
    .modal-header,.modal-footer{background:#f8fafc;border-color:#e5e7eb}
    .modal-header{padding:14px 18px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center}
    .modal-title{font-weight:700;color:#0f172a;font-size:16px}
    .modal-close{border:0;background:transparent;font-size:18px;color:#64748b;cursor:pointer}
    .modal-body{padding:18px;max-height:60vh;overflow:auto;color:#334155}
    .modal-footer{padding:12px;border-top:1px solid #e5e7eb;display:flex;justify-content:flex-end;gap:8px}
    .btn-ghost{background:#e5e7eb;color:#111827;padding:10px 14px;border-radius:10px;border:0;font-weight:600;cursor:pointer}
    .btn-ghost:hover{filter:brightness(.98)}
    .modal-form .form-row{margin-bottom:12px}
    .modal-form label{display:block;font-size:13px;font-weight:600;color:#374151;margin-bottom:6px}
    .modal-form input,.modal-form select,.modal-form textarea{width:100%;padding:10px 12px;border:2px solid #e5e7eb;border-radius:10px;font-size:14px;background:#fff}
    .modal-form textarea{min-height:90px;resize:vertical}

    /* Responsive */
    @media (max-width:1024px){
      .settings-grid{grid-template-columns:1fr;gap:20px}
    }
    @media (max-width:768px){
      .mobile-menu-toggle{display:block}
      .sidebar{transform:translateX(-100%)}
      .sidebar.active{transform:translateX(0)}
      .main-content{margin-left:0}
      .header{flex-direction:column;gap:20px;text-align:center;margin-top:60px}
      .content-grid{grid-template-columns:1fr}
      .dashboard-metrics{grid-template-columns:1fr}
      .container{padding:15px}
    }
  </style>
</head>

<body>
  <!-- Infra global (uma vez) -->
  <div id="modal-root"></div>

  <!-- ===== MARCAÇÃO (SIDEBAR + MAIN) ===== -->
  <button class="mobile-menu-toggle" onclick="toggleSidebar()">
    <i class="fas fa-bars" aria-hidden="true"></i>
    <span class="sr-only">Abrir menu</span>
  </button>
  <div class="sidebar-overlay" onclick="toggleSidebar(false)"></div>

  <nav class="sidebar" id="sidebar" aria-label="Navegação principal">
    <div class="sidebar-header">
      <h2>
        <span class="logo-icon" aria-hidden="true"><i class="fab fa-whatsapp"></i></span>
        WhatsApp Bot
      </h2>
    </div>

    <div class="sidebar-nav">
      <div class="nav-section">
        <div class="nav-section-title">Principal</div>
        <div class="nav-item active" onclick="changeTab('dashboard', this)">
          <i class="fas fa-chart-pie nav-icon" aria-hidden="true"></i>
          <span class="nav-text">Dashboard</span>
        </div>
        <div class="nav-item" onclick="changeTab('numbers', this)">
          <i class="fas fa-phone nav-icon" aria-hidden="true"></i>
          <span class="nav-text">Números Conectados</span>
        </div>
      </div>

      <div class="nav-section">
        <div class="nav-section-title">Comunicação</div>
        <div class="nav-item" onclick="changeTab('contacts', this)">
          <i class="fas fa-address-book nav-icon" aria-hidden="true"></i>
          <span class="nav-text">Contatos</span>
        </div>
        <div class="nav-item" onclick="changeTab('messages', this)">
          <i class="fas fa-comments nav-icon" aria-hidden="true"></i>
          <span class="nav-text">Mensagens</span>
          <span class="nav-badge">3</span>
        </div>
        <div class="nav-item" onclick="changeTab('groups', this)">
          <i class="fas fa-users nav-icon" aria-hidden="true"></i>
          <span class="nav-text">Grupos</span>
        </div>
      </div>

      <div class="nav-section">
        <div class="nav-section-title">Gestão</div>
        <div class="nav-item" onclick="changeTab('finances', this)">
          <i class="fas fa-dollar-sign nav-icon" aria-hidden="true"></i>
          <span class="nav-text">Finanças</span>
        </div>
        <div class="nav-item" onclick="changeTab('settings', this)">
          <i class="fas fa-cog nav-icon" aria-hidden="true"></i>
          <span class="nav-text">Configurações</span>
        </div>
      </div>

      <div class="nav-section">
        <div class="nav-section-title">Automação</div>
        <div class="nav-item" onclick="changeTab('campaigns', this)">
          <i class="fas fa-bullhorn nav-icon" aria-hidden="true"></i>
          <span class="nav-text">Campanhas</span>
        </div>
        <div class="nav-item" onclick="changeTab('macros', this)">
          <i class="fas fa-magic nav-icon" aria-hidden="true"></i>
          <span class="nav-text">Macros</span>
        </div>
        <div class="nav-item" onclick="changeTab('chatbot', this)">
          <i class="fas fa-robot nav-icon" aria-hidden="true"></i>
          <span class="nav-text">Chatbot</span>
        </div>
        <div class="nav-item" onclick="changeTab('schedules', this)">
          <i class="fas fa-calendar-alt nav-icon" aria-hidden="true"></i>
          <span class="nav-text">Agendamentos</span>
        </div>
        <div class="nav-item" onclick="changeTab('reports', this)">
          <i class="fas fa-chart-line nav-icon" aria-hidden="true"></i>
          <span class="nav-text">Relatórios</span>
        </div>
      </div>
    </div>

    <!-- Footer: Seletor de Usuários/Contas -->
    <div class="sidebar-footer">
      <div class="instance-selector" onclick="toggleInstanceMenu()" role="button" aria-haspopup="true" aria-expanded="false">
        <div class="instance-avatar">
          <img id="instanceAvatar"
               src="https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=80&h=80&fit=crop&crop=faces"
               alt="Avatar do usuário">
          <div class="instance-status"></div>
        </div>
        <div class="instance-info">
          <div class="instance-name" id="currentInstanceName">Sem usuário</div>
          <div class="instance-type" id="currentInstanceType">—</div>
        </div>
        <div class="instance-arrow" aria-hidden="true"><i id="instanceArrow" class="fas fa-chevron-up"></i></div>
      </div>

      <div class="instance-dropdown" id="instanceDropdown">
        <div class="dropdown-header">Trocar usuário</div>
        <div id="instanceList"><!-- render via JS --></div>
        <div class="dropdown-footer">
          <div class="dropdown-action" onclick="userNew()">
            <i class="fas fa-user-plus" aria-hidden="true"></i><span>Novo usuário</span>
          </div>
          <div class="dropdown-action" onclick="userEditActive()">
            <i class="fas fa-user-cog" aria-hidden="true"></i><span>Configurar usuário</span>
          </div>
          <div class="dropdown-action" onclick="toggleInstanceMenu(false)">
            <i class="fas fa-chevron-down" aria-hidden="true"></i><span>Fechar</span>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <main class="main-content" role="main">
    <div class="container" id="mainContainer"><!-- conteúdo renderizado via JS --></div>
  </main>

  <script>
  /* ---------------------------
     Estado + persistência
  --------------------------- */
  window.AppState = window.AppState || {
    version: 'v1',
    currentUserId: null,
    users: [],
    conversationsByUser: {},
    financesByUser: {},
    campaignsByUser: {},
    groupsByUser: {},
    schedulesByUser: {}
  };

  function uid(){ return 'id_' + Math.random().toString(36).slice(2,9) + Date.now().toString(36); }
  function esc(s=''){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }

  function saveState(){ 
    try{ 
      localStorage.setItem('wb_state', JSON.stringify(AppState)); 
    } catch(e) {
      console.error('Erro ao salvar estado:', e);
    }
  }
  
  function loadState(){
    try{
      const raw = localStorage.getItem('wb_state');
      if(raw){
        const parsed = JSON.parse(raw);
        if(parsed && parsed.users) {
          AppState = Object.assign(AppState, parsed);
        }
      }
    } catch(e) {
      console.error('Erro ao carregar estado:', e);
    }
  }

  /* ---------------------------
     Helpers de UI / layout
  --------------------------- */
  function toggleSidebar(force){
    const sidebar = document.getElementById('sidebar');
    const overlay = document.querySelector('.sidebar-overlay');
    if(!sidebar||!overlay) return;
    const willShow = typeof force==='boolean' ? force : !sidebar.classList.contains('active');
    sidebar.classList.toggle('active', willShow);
    overlay.classList.toggle('active', willShow);
  }

  function toggleInstanceMenu(force){
    const dd = document.getElementById('instanceDropdown');
    const arrow = document.getElementById('instanceArrow');
    if(!dd) return;
    const willShow = typeof force==='boolean' ? force : !dd.classList.contains('active');
    dd.classList.toggle('active', willShow);
    if(arrow) arrow.classList.toggle('active', willShow);
  }

  /* ---------------------------
     Modais (sem libs)
  --------------------------- */
  function ensureModalInfra(){
    if(!document.getElementById('modal-root')){
      const root = document.createElement('div');
      root.id = 'modal-root';
      document.body.appendChild(root);
    }
  }

  function mountModal({ title='Atenção', html='', buttons=[], dismissible=true }) {
    ensureModalInfra();
    return new Promise((resolve,reject)=>{
      const root=document.getElementById('modal-root');
      const overlay=document.createElement('div'); 
      overlay.className='modal-overlay'; 
      overlay.setAttribute('role','dialog'); 
      overlay.setAttribute('aria-modal','true');
      
      const box=document.createElement('div'); 
      box.className='modal-box';
      box.innerHTML=`
        <div class="modal-header">
          <div class="modal-title">${title}</div>
          <button class="modal-close" aria-label="Fechar">&times;</button>
        </div>
        <div class="modal-body">${html}</div>
        <div class="modal-footer"></div>`;
      
      const footer=box.querySelector('.modal-footer');
      buttons.forEach(btn=>{
        const el=document.createElement('button');
        el.className=btn.variant==='primary'?'btn-primary':'btn-ghost';
        el.type='button';
        el.innerHTML=btn.icon?`<i class="${btn.icon}"></i> ${btn.text}`:btn.text;
        el.onclick=()=>close('resolve',btn.value);
        footer.appendChild(el);
      });
      
      function close(kind='resolve',val=null){
        overlay.removeEventListener('click',onOverlay); 
        document.removeEventListener('keydown',onEsc);
        root.removeChild(overlay); 
        kind==='resolve'?resolve(val):reject(val);
      }
      
      function onOverlay(e){ 
        if(!dismissible) return; 
        if(e.target===overlay) close('reject',null); 
      }
      
      function onEsc(e){ 
        if(e.key==='Escape'&&dismissible) close('reject',null); 
      }
      
      overlay.appendChild(box); 
      root.appendChild(overlay);
      overlay.addEventListener('click',onOverlay); 
      document.addEventListener('keydown',onEsc);
      box.querySelector('.modal-close').onclick=()=>close('reject',null);
      
      setTimeout(()=>{ 
        const focusEl = box.querySelector('input,select,textarea,button.btn-primary');
        if(focusEl && focusEl.focus) focusEl.focus();
      }, 10);
    });
  }
  
  function uiAlert(message,title='Atenção'){
    return mountModal({ 
      title, 
      html:`<p style="line-height:1.55">${String(message).replace(/\n/g,'<br>')}</p>`,
      buttons:[{text:'OK',variant:'primary',value:true}] 
    });
  }
  
  function uiConfirm(message,title='Confirmar'){
    return mountModal({ 
      title, 
      html:`<p style="line-height:1.55">${String(message).replace(/\n/g,'<br>')}</p>`,
      buttons:[
        {text:'Cancelar',variant:'ghost',value:false},
        {text:'Confirmar',variant:'primary',value:true}
      ] 
    });
  }
  
  function uiForm(title='Formulário', fields=[], submitLabel='Confirmar'){
    ensureModalInfra();
    const id='f_'+Math.random().toString(36).slice(2,8);
    const body=fields.map(f=>{
      if(f.type==='textarea') {
        return `<div class="form-row"><label>${esc(f.label||f.name)}</label><textarea name="${esc(f.name)}" placeholder="${esc(f.placeholder||'')}">${esc(f.value||'')}</textarea></div>`;
      }
      if(f.type==='select'){ 
        const opts=(f.options||[]).map(o=>`<option value="${esc(o.value)}" ${o.value==f.value?'selected':''}>${esc(o.label)}</option>`).join('');
        return `<div class="form-row"><label>${esc(f.label||f.name)}</label><select name="${esc(f.name)}">${opts}</select></div>`; 
      }
      return `<div class="form-row"><label>${esc(f.label||f.name)}</label><input type="${f.type||'text'}" name="${esc(f.name)}" placeholder="${esc(f.placeholder||'')}" value="${esc(f.value||'')}" ${f.required?'required':''}/></div>`;
    }).join('');
    
    const html=`<form id="${id}" class="modal-form">${body}</form>`;
    
    return mountModal({
      title, html, dismissible:false,
      buttons:[
        {text:'Cancelar',variant:'ghost',value:null},
        {text:submitLabel,variant:'primary',value:'__submit__'}
      ]
    }).then(v=>{
      if(v==='__submit__'){ 
        const form=document.getElementById(id); 
        const data={}; 
        fields.forEach(f=>{ 
          const el=form.querySelector(`[name="${f.name}"]`); 
          data[f.name]=el?el.value:null; 
        }); 
        return data; 
      }
      return null;
    });
  }

  /* ---------------------------
     Usuários (rodapé)
  --------------------------- */
  function getCurrentUser(){ 
    return AppState.users.find(u=>u.id===AppState.currentUserId)||null; 
  }

  async function userNew(){
    try {
      const v = await uiForm('Novo Usuário', [
        {name:'name',label:'Nome / Apelido',type:'text',required:true,placeholder:'Ex.: Comercial'},
        {name:'username',label:'Usuário (login)',type:'text',required:true,placeholder:'ex.: comercial01'},
        {name:'password',label:'Senha',type:'password',required:true,placeholder:'••••••••'}
      ], 'Criar');
      
      if(!v) return;

      AppState.users = AppState.users || [];
      if(AppState.users.some(u=> (u.username||'').toLowerCase() === String(v.username||'').toLowerCase())){
        await uiAlert('Já existe um usuário com esse login.'); 
        return;
      }
      
      const user = { 
        id: uid(), 
        name: v.name.trim(), 
        username: v.username.trim(), 
        password: v.password, 
        createdAt: Date.now(), 
        instances: [] 
      };
      
      AppState.users.push(user);
      AppState.currentUserId = user.id;
      saveState();
      renderUserUI();
      
      // Force UI update
      setTimeout(() => {
        renderUserUI();
        changeTab('dashboard');
      }, 100);
    } catch(e) {
      console.error('Erro ao criar usuário:', e);
    }
  }

  async function userEditActive(){
    try {
      const u = getCurrentUser();
      if(!u){ 
        await uiAlert('Nenhum usuário selecionado.'); 
        return; 
      }
      
      const v = await uiForm('Configurar Usuário', [
        {name:'name',label:'Nome / Apelido',type:'text',value:u.name,required:true},
        {name:'username',label:'Usuário (login)',type:'text',value:u.username,required:true},
        {name:'password',label:'Senha',type:'password',value:u.password,required:true}
      ], 'Salvar');
      
      if(!v) return;

      if(v.username!==u.username && (AppState.users||[]).some(x=>x.username===v.username)){ 
        await uiAlert('Esse login já está em uso.'); 
        return; 
      }
      
      u.name = v.name.trim(); 
      u.username = v.username.trim(); 
      u.password = v.password;
      saveState();
      
      // Force UI update
      setTimeout(() => {
        renderUserUI();
      }, 100);
    } catch(e) {
      console.error('Erro ao editar usuário:', e);
    }
  }

  function selectUser(id){
    AppState.currentUserId = id;
    saveState();
    renderUserUI();
    toggleInstanceMenu(false);
    changeTab('dashboard');
  }

  function renderUserUI(){
    try {
      const nameEl = document.getElementById('currentInstanceName');
      const typeEl = document.getElementById('currentInstanceType');
      const listEl = document.getElementById('instanceList');
      const avatarEl = document.getElementById('instanceAvatar');
      const u = getCurrentUser();

      if (nameEl) {
        nameEl.textContent = u ? u.name : 'Sem usuário';
        console.log('Atualizando nome do usuário:', u ? u.name : 'Sem usuário');
      }
      if (typeEl) typeEl.textContent = u ? '@'+u.username : '—';
      if (avatarEl) avatarEl.src = u ? ('https://i.pravatar.cc/80?u='+encodeURIComponent(u.username)) : 'https://i.pravatar.cc/80?img=1';

    if(!listEl) return;
    const users = AppState.users||[];
    if(!users.length){
      listEl.innerHTML = '<div style="padding:16px 20px;color:#64748b;font-size:13px;">Nenhum usuário criado.</div>';
      return;
    }
    
    listEl.innerHTML = users.map(us=>`
      <div class="instance-item ${us.id===AppState.currentUserId?'active':''}" onclick="selectUser('${us.id}')">
        <div class="instance-avatar-small">
          <img src="https://i.pravatar.cc/80?u=${encodeURIComponent(us.username||us.id)}" alt="Avatar">
          <div class="status-dot ${us.id===AppState.currentUserId?'active':'offline'}"></div>
        </div>
        <div class="instance-details">
          <div class="name">${esc(us.name)}</div>
          <div class="type">@${esc(us.username)}</div>
        </div>
        ${us.id===AppState.currentUserId ? '<i class="fas fa-check instance-check"></i>' : ''}
      </div>
    `).join('');
  }

  /* ---------------------------
     Roteador (abas) + Telas base
  --------------------------- */
  function changeTab(tabName, el){
    // Remove active de todos os itens
    document.querySelectorAll('.nav-item').forEach(i=>i.classList.remove('active'));
    if(el) el.classList.add('active');
    
    const container = document.getElementById('mainContainer');
    if(!container) return;

    const user = getCurrentUser();
    
    try {
      if(tabName==='dashboard'){
        container.innerHTML = renderDashboard(user);
      } else if(tabName==='numbers'){
        container.innerHTML = renderNumbers(user);
      } else if(tabName==='finances'){
        container.innerHTML = renderFinances(user);
        setupFinancesHandlers();
      } else if(tabName==='messages'){
        container.innerHTML = renderMessages(user);
        setupMessagesHandlers();
      } else if(tabName==='groups'){
        container.innerHTML = renderGroups(user);
        setupGroupsHandlers();
      } else if(tabName==='campaigns'){
        container.innerHTML = renderCampaigns(user);
        setupCampaignsHandlers();
      } else if(tabName==='schedules'){
        container.innerHTML = renderSchedules(user);
        setupSchedulesHandlers();
      } else if(tabName==='contacts'){
        container.innerHTML = renderPlaceholder('Contatos');
      } else if(tabName==='settings'){
        container.innerHTML = renderPlaceholder('Configurações do Sistema');
      } else if(tabName==='macros'){
        container.innerHTML = renderPlaceholder('Macros');
      } else if(tabName==='chatbot'){
        container.innerHTML = renderPlaceholder('Chatbot');
      } else if(tabName==='reports'){
        container.innerHTML = renderPlaceholder('Relatórios e Analytics');
      } else {
        container.innerHTML = renderPlaceholder('Página em Desenvolvimento');
      }
      
      if (window.innerWidth <= 768) toggleSidebar(false);
    } catch(e) {
      console.error('Erro ao mudar aba:', e);
      container.innerHTML = `<div class="header"><h1>Erro</h1></div><div style="padding:20px;color:red;">Erro ao carregar conteúdo: ${e.message}</div>`;
    }
  }

  function renderPlaceholder(titulo){
    return `
      <div class="header">
        <h1><i class="fas fa-wrench"></i> ${esc(titulo)}</h1>
      </div>
      <div style="text-align:center;padding:60px 20px;background:rgba(255,255,255,.95);border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.1);">
        <i class="fas fa-code" style="font-size:64px;color:#9ca3af;margin-bottom:20px;"></i>
        <h2 style="margin:0 0 10px 0;color:#4b5563;">Em construção</h2>
        <p style="margin:0;color:#6b7280;">Conteúdo será adicionado nas próximas partes.</p>
      </div>
    `;
  }

  function renderDashboard(user){
    const total = user ? (user.instances||[]).length : 0;
    const title = user ? `Dashboard — ${esc(user.name)}` : 'Dashboard';
    return `
      <div class="header">
        <h1><i class="fas fa-chart-pie"></i> ${title}</h1>
      </div>

      <div class="dashboard-metrics">
        <div class="metric-card">
          <div class="metric-header">
            <div class="metric-title">Usuário ativo</div>
            <div class="metric-icon"><i class="fas fa-user"></i></div>
          </div>
          <div class="metric-value">${user ? esc(user.username) : '—'}</div>
          <div class="metric-subtitle">${user ? 'logado' : 'nenhum selecionado'}</div>
        </div>

        <div class="metric-card">
          <div class="metric-header">
            <div class="metric-title">Números conectados</div>
            <div class="metric-icon"><i class="fas fa-phone"></i></div>
          </div>
          <div class="metric-value">${total}</div>
          <div class="metric-subtitle">por usuário</div>
        </div>

        <div class="metric-card">
          <div class="metric-header">
            <div class="metric-title">Mensagens (24h)</div>
            <div class="metric-icon"><i class="fas fa-comments"></i></div>
          </div>
          <div class="metric-value">0</div>
          <div class="metric-subtitle">placeholder</div>
        </div>

        <div class="metric-card">
          <div class="metric-header">
            <div class="metric-title">Status</div>
            <div class="metric-icon"><i class="fas fa-signal"></i></div>
          </div>
          <div class="metric-value">${user ? 'OK' : '—'}</div>
          <div class="metric-subtitle">sistema</div>
        </div>
      </div>
    `;
  }

  function _ago(ts){ 
    if(!ts) return '—'; 
    const d=Date.now()-ts, m=Math.floor(d/60000); 
    if(m<1) return 'agora'; 
    if(m<60) return `${m} min`; 
    const h=Math.floor(m/60); 
    if(h<24) return `${h} h`; 
    const dd=Math.floor(h/24); 
    return `${dd} d`; 
  }

  function renderNumbers(user){
    const list = (user?.instances||[]).slice().sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
    return `
      <div class="header">
        <h1><i class="fas fa-phone"></i> Números Conectados</h1>
        <button class="btn-primary" onclick="numbersNew()"><i class="fas fa-plus"></i> Conectar Número</button>
      </div>

      <div class="content-grid">
        ${list.length ? list.map(n=>numberCard(n)).join('') :
          `<div style="grid-column:1/-1">${emptyCard('Nenhum número cadastrado')}</div>`}
      </div>
    `;
  }
  
  function emptyCard(text){
    return `
      <div class="content-card">
        <div class="card-header"><h3 class="card-title">${esc(text)}</h3></div>
        <p class="card-subtitle">Crie um número clicando em "Conectar Número".</p>
      </div>`;
  }
  
  function numberCard(n){
    const statusClass = n.status==='active' ? 'status-active' : (n.status==='pending' ? 'status-pending' : 'status-offline');
    const statusText  = n.status==='active' ? 'Online' : (n.status==='pending' ? 'Aguardando' : 'Offline');
    const msgsToday   = n.metrics?.today ?? 0;
    const groups      = n.metrics?.groups ?? 0;
    const lastAccess  = n.lastAccess ? new Date(n.lastAccess).toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'}) : '—';

    return `
      <div class="content-card">
        <div class="card-status ${statusClass}">${statusText}</div>
        <div class="card-header">
          <div>
            <h3 class="card-title">${esc(n.name||'(sem apelido)')} ${n.phone?`• ${esc(n.phone)}`:''}</h3>
            <p class="card-subtitle">Criado há ${_ago(n.createdAt)} • Último acesso ${esc(lastAccess)}</p>
          </div>
        </div>

        <div class="metric-breakdown">
          <div class="breakdown-item"><span class="breakdown-label">Mensagens hoje</span><span class="breakdown-value">${msgsToday}</span></div>
          <div class="breakdown-item"><span class="breakdown-label">Grupos ativos</span><span class="breakdown-value">${groups}</span></div>
        </div>

        <div class="card-actions">
          <button class="btn-action btn-edit" onclick="numbersEdit('${n.id}')"><i class="fas fa-cog"></i> Configurar</button>
          ${n.status!=='active'
            ? `<button class="btn-action btn-connect" onclick="numbersReconnect('${n.id}')"><i class="fas fa-link"></i> Reconectar</button>`
            : `<button class="btn-action btn-delete" onclick="numbersDisconnect('${n.id}')"><i class="fas fa-unlink"></i> Desconectar</button>`}
          <button class="btn-action btn-delete" onclick="numbersRemove('${n.id}')"><i class="fas fa-trash"></i> Remover</button>
        </div>
      </div>
    `;
  }

  async function numbersNew(){
    try {
      const u = getCurrentUser();
      if(!u){ 
        await uiAlert('Selecione ou crie um usuário primeiro.'); 
        return; 
      }
      
      const v = await uiForm('Conectar Número', [
        {name:'name',label:'Apelido',type:'text',required:true,placeholder:'Ex.: Comercial 01'},
        {name:'phone',label:'Telefone (com DDI/DDD)',type:'text',required:true,placeholder:'+55 31 99999-0000'}
      ], 'Conectar');
      
      if(!v) return;

      u.instances = u.instances || [];
      u.instances.unshift({
        id: uid(),
        name: v.name.trim(),
        phone: v.phone.trim(),
        status: 'pending',
        createdAt: Date.now(),
        lastAccess: null,
        metrics: { today: 0, groups: 0 }
      });
      saveState();
      await uiAlert('Número criado. Gere o QR Code em "Reconectar" para finalizar a conexão.', 'Conexão pendente');
      rerenderNumbers();
    } catch(e) {
      console.error('Erro ao criar número:', e);
    }
  }

  async function numbersEdit(id){
    try {
      const u = getCurrentUser(); 
      if(!u) return;
      
      const n = u.instances.find(x=>x.id===id); 
      if(!n) return;
      
      const v = await uiForm('Configurar Número', [
        {name:'name',label:'Apelido',type:'text',value:n.name,required:true},
        {name:'phone',label:'Telefone',type:'text',value:n.phone,required:true},
        {name:'status',label:'Status',type:'select',value:n.status,options:[
          {label:'Online',value:'active'},{label:'Aguardando',value:'pending'},{label:'Offline',value:'offline'}
        ]}
      ], 'Salvar');
      
      if(!v) return;
      
      n.name=v.name.trim(); 
      n.phone=v.phone.trim(); 
      n.status=v.status;
      saveState(); 
      rerenderNumbers();
    } catch(e) {
      console.error('Erro ao editar número:', e);
    }
  }

  async function numbersReconnect(id){
    try {
      const u = getCurrentUser(); 
      if(!u) return;
      
      const n = u.instances.find(x=>x.id===id); 
      if(!n) return;
      
      const ok = await uiConfirm('Gerar novo QR Code e marcar como Online?');
      if(!ok) return;
      
      n.status='active'; 
      n.lastAccess=Date.now();
      saveState(); 
      rerenderNumbers();
    } catch(e) {
      console.error('Erro ao reconectar:', e);
    }
  }
  
  async function numbersDisconnect(id){
    try {
      const u = getCurrentUser(); 
      if(!u) return;
      
      const n = u.instances.find(x=>x.id===id); 
      if(!n) return;
      
      const ok = await uiConfirm('Desconectar este número (ficará Offline)?');
      if(!ok) return;
      
      n.status='offline';
      saveState(); 
      rerenderNumbers();
    } catch(e) {
      console.error('Erro ao desconectar:', e);
    }
  }
  
  async function numbersRemove(id){
    try {
      const u = getCurrentUser(); 
      if(!u) return;
      
      const ok = await uiConfirm('Remover definitivamente este número?');
      if(!ok) return;
      
      const i = u.instances.findIndex(x=>x.id===id);
      if(i>=0) u.instances.splice(i,1);
      saveState(); 
      rerenderNumbers();
    } catch(e) {
      console.error('Erro ao remover número:', e);
    }
  }
  
  function rerenderNumbers(){
    const container=document.getElementById('mainContainer');
    if(!container) return;
    container.innerHTML = renderNumbers(getCurrentUser());
  }

  // Placeholder functions for other modules
  function renderFinances(user) {
    return renderPlaceholder('Finanças');
  }

  function renderMessages(user) {
    return renderPlaceholder('Central de Mensagens');
  }

  function renderGroups(user) {
    return renderPlaceholder('Grupos');
  }

  function renderCampaigns(user) {
    return renderPlaceholder('Campanhas');
  }

  function renderSchedules(user) {
    return renderPlaceholder('Agendamentos');
  }

  function setupFinancesHandlers() {}
  function setupMessagesHandlers() {}
  function setupGroupsHandlers() {}
  function setupCampaignsHandlers() {}
  function setupSchedulesHandlers() {}

  /* ---------------------------
     Bootstrap
  --------------------------- */
  document.addEventListener('DOMContentLoaded', ()=>{
    try {
      loadState();
      renderUserUI();
      changeTab('dashboard');
      
      // Close dropdown when clicking outside
      document.addEventListener('click', (e)=>{
        if(!e.target.closest('.sidebar-footer')) {
          toggleInstanceMenu(false);
        }
      });
    } catch(e) {
      console.error('Erro na inicialização:', e);
    }
  });
  </script>
</body>
</html>